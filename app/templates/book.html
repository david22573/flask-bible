{% extends 'base.html' %}

{% block head %}
<title x-text="documentTitle">{{ book.name }}</title>
<meta
    name="description"
    :content="`Reading ${book.name}, Chapter ${currentChapter}`"
>
{% endblock %}

{% block content %}
<div
    class="reader"
    x-data="bibleReader()"
    x-init="init()"
    data-book='{{ book | tojson | safe }}'
    data-initial-chapter='{{ initial_chapter | tojson | safe }}'
    data-chapter-api-template="/api/book/{{ book.id }}/chapter/CHAPTER_NUMBER"
    @keydown.escape="sidebarOpen = false"
    @keydown.left="previousChapter()"
    @keydown.right="nextChapter()"
>
    <!-- Mobile Menu Toggle -->
    <button
        class="menu-toggle"
        @click="sidebarOpen = !sidebarOpen"
        :class="{ active: sidebarOpen }"
        aria-label="Toggle navigation menu"
        :aria-expanded="sidebarOpen"
    >
        <span></span><span></span><span></span>
    </button>

    <!-- Backdrop for mobile -->
    <div
        x-show="sidebarOpen"
        x-transition:enter="transition-opacity ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-in duration-300"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="sidebar-backdrop"
        @click="sidebarOpen = false"
        style="display: none"
    ></div>

    <!-- Sidebar -->
    <aside
        class="sidebar"
        :class="{ active: sidebarOpen }"
        x-transition:enter="transition-transform ease-out duration-300"
        x-transition:enter-start="transform -translate-x-full"
        x-transition:enter-end="transform translate-x-0"
        x-transition:leave="transition-transform ease-in duration-300"
        x-transition:leave-start="transform translate-x-0"
        x-transition:leave-end="transform -translate-x-full"
        role="navigation"
        aria-label="Chapter navigation"
    >
        <div class="sidebar-inner">
            <div class="sidebar-header">
                <a
                    href="{{ url_for('bible.home') }}"
                    class="back-button"
                    aria-label="Back to book selection"
                >
                    <span
                        class="back-arrow"
                        aria-hidden="true"
                    >‚Üê</span>
                    <span>Back to Books</span>
                </a>
                <h2
                    class="sidebar-title"
                    x-text="book.name"
                ></h2>
                <div class="sidebar-subtitle">
                    <span
                        x-text="`Chapter ${currentChapter} of ${book.total_chapters}`"
                    ></span>
                    <div class="reading-progress">
                        <div
                            class="progress-bar"
                            :style="`width: ${(currentChapter / book.total_chapters) * 100}%`"
                        ></div>
                    </div>
                </div>
            </div>

            <!-- Chapter Search/Filter -->
            <div class="chapter-search">
                <input
                    type="number"
                    x-model="chapterSearch"
                    :max="book.total_chapters"
                    min="1"
                    placeholder="Go to chapter..."
                    class="chapter-input"
                    @keydown.enter="goToChapter()"
                    @input="validateChapterInput()"
                >
                <button
                    class="go-button"
                    @click="goToChapter()"
                    :disabled="!isValidChapter"
                    aria-label="Go to chapter"
                >
                    Go
                </button>
            </div>

            <!-- Chapter List -->
            <div class="chapter-list-container">
                <ul
                    class="chapter-list"
                    role="list"
                >
                    <template
                        x-for="i in book.total_chapters"
                        :key="i"
                    >
                        <li
                            class="chapter-item"
                            role="listitem"
                        >
                            <button
                                class="chapter-link"
                                :class="{ 
                                    'active': currentChapter === i,
                                    'visited': visitedChapters.includes(i)
                                }"
                                @click="selectChapter(i)"
                                :aria-label="`Go to chapter ${i}`"
                                :aria-current="currentChapter === i ? 'page' : false"
                                type="button"
                            >
                                <span
                                    class="chapter-number"
                                    x-text="i"
                                ></span>
                                <span class="chapter-label">Chapter</span>
                                <span
                                    x-show="visitedChapters.includes(i)"
                                    class="visited-indicator"
                                    aria-hidden="true"
                                >‚úì</span>
                            </button>
                        </li>
                    </template>
                </ul>
            </div>
        </div>
    </aside>

    <!-- Main Reading Pane -->
    <main
        class="chapter-pane"
        role="main"
    >
        <!-- Reading Controls -->
        <header
            class="reading-controls"
            role="banner"
        >
            <div class="controls-left">
                <button
                    class="control-btn"
                    @click="sidebarOpen = !sidebarOpen"
                    :aria-label="sidebarOpen ? 'Close sidebar' : 'Open sidebar'"
                    :aria-expanded="sidebarOpen"
                    title="Toggle sidebar (Esc to close)"
                >
                    <span
                        class="icon"
                        x-html="sidebarOpen ? '‚úï' : '‚ò∞'"
                    ></span>
                </button>

                <div class="chapter-quick-nav">
                    <button
                        class="control-btn"
                        @click="previousChapter()"
                        :disabled="currentChapter === 1"
                        title="Previous chapter (‚Üê)"
                        aria-label="Go to previous chapter"
                    >
                        ‚Äπ
                    </button>
                    <span
                        class="current-chapter"
                        x-text="currentChapter"
                    ></span>
                    <button
                        class="control-btn"
                        @click="nextChapter()"
                        :disabled="currentChapter === book.total_chapters"
                        title="Next chapter (‚Üí)"
                        aria-label="Go to next chapter"
                    >
                        ‚Ä∫
                    </button>
                </div>
            </div>

            <div class="controls-right">
                <!-- Reading Settings -->
                <div
                    class="reading-settings"
                    x-data="{ settingsOpen: false }"
                >
                    <button
                        class="control-btn"
                        @click="settingsOpen = !settingsOpen"
                        title="Reading settings"
                        aria-label="Open reading settings"
                        :aria-expanded="settingsOpen"
                    >
                        ‚öô
                    </button>

                    <div
                        x-show="settingsOpen"
                        x-transition
                        @click.away="settingsOpen = false"
                        class="settings-dropdown"
                    >
                        <div class="font-controls">
                            <label class="setting-label">Font Size</label>
                            <div class="font-buttons">
                                <button
                                    class="font-btn"
                                    @click="decreaseFontSize()"
                                    :disabled="fontSize <= 14"
                                    title="Decrease font size"
                                >A-</button>
                                <span
                                    class="font-size-indicator"
                                    x-text="fontSize + 'px'"
                                ></span>
                                <button
                                    class="font-btn"
                                    @click="increaseFontSize()"
                                    :disabled="fontSize >= 32"
                                    title="Increase font size"
                                >A+</button>
                            </div>
                        </div>

                        <div class="theme-controls">
                            <label class="setting-label">Theme</label>
                            <button
                                class="theme-btn"
                                @click="toggleTheme()"
                                :title="`Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`"
                                aria-label="Toggle theme"
                            >
                                <span
                                    x-text="theme === 'dark' ? 'üåû' : 'üåô'"></span>
                                <span
                                    x-text="theme === 'dark' ? 'Light' : 'Dark'"
                                ></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Chapter Content -->
        <div
            class="chapter-content-wrapper"
            x-ref="contentWrapper"
        >
            <!-- Loading State -->
            <template x-if="loading">
                <div
                    class="loading-state"
                    aria-live="polite"
                    aria-label="Loading chapter content"
                >
                    <div class="loading-spinner"></div>
                    <p class="loading-text">Loading Chapter <span
                            x-text="currentChapter"
                        ></span>...</p>
                </div>
            </template>

            <!-- Error State -->
            <template x-if="error && !loading">
                <div
                    class="error-state"
                    role="alert"
                >
                    <h3>Unable to load chapter</h3>
                    <p x-text="error"></p>
                    <button
                        class="retry-btn"
                        @click="retryLoad()"
                    >
                        Try Again
                    </button>
                </div>
            </template>

            <!-- Main Content -->
            <div
                x-show="!loading && !error"
                x-transition:enter="transition-opacity ease-in duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                class="chapter-content"
                :style="`font-size: ${fontSize}px; line-height: ${Math.max(1.4, fontSize * 0.07)}; font-family: ${fontFamily}`"
            >
                <header class="chapter-header">
                    <h1 class="chapter-title">
                        <span x-text="book.name"></span>
                        <span
                            class="chapter-number-large"
                            x-text="currentChapter"
                        ></span>
                    </h1>
                    <div class="chapter-info">
                        <span
                            class="verse-count"
                            x-text="`${currentVerses.length} verses`"
                        ></span>
                        <span
                            class="reading-time"
                            x-text="estimatedReadTime"
                        ></span>
                    </div>
                </header>

                <section
                    class="verses"
                    role="main"
                >
                    <template
                        x-for="verse in currentVerses"
                        :key="verse.id"
                    >
                        <p
                            class="verse"
                            :id="`verse-${verse.verse_number}`"
                            @click="selectVerse(verse.verse_number)"
                            :class="{ 'selected': selectedVerse === verse.verse_number }"
                        >
                            <span
                                class="verse-number"
                                x-text="verse.verse_number"
                                aria-label="`Verse ${verse.verse_number}`"
                            ></span>
                            <span
                                class="verse-text"
                                x-text="verse.text"
                            ></span>
                        </p>
                    </template>
                </section>

                <!-- Chapter Navigation -->
                <nav
                    class="chapter-navigation"
                    role="navigation"
                    aria-label="Chapter navigation"
                >
                    <button
                        class="nav-btn nav-prev"
                        @click="previousChapter()"
                        :disabled="currentChapter === 1"
                        :aria-label="`Go to chapter ${currentChapter - 1}`"
                    >
                        <span aria-hidden="true">‚Üê</span>
                        <span>Previous</span>
                        <span
                            class="nav-chapter-hint"
                            x-show="currentChapter > 1"
                            x-text="`Ch. ${currentChapter - 1}`"
                        ></span>
                    </button>

                    <div class="nav-center">
                        <span
                            class="progress-text"
                            x-text="`${currentChapter} / ${book.total_chapters}`"
                        ></span>
                        <div class="chapter-progress-bar">
                            <div
                                class="progress-fill"
                                :style="`width: ${(currentChapter / book.total_chapters) * 100}%`"
                            ></div>
                        </div>
                    </div>

                    <button
                        class="nav-btn nav-next"
                        @click="nextChapter()"
                        :disabled="currentChapter === book.total_chapters"
                        :aria-label="`Go to chapter ${currentChapter + 1}`"
                    >
                        <span
                            class="nav-chapter-hint"
                            x-show="currentChapter < book.total_chapters"
                            x-text="`Ch. ${currentChapter + 1}`"
                        ></span>
                        <span>Next</span>
                        <span aria-hidden="true">‚Üí</span>
                    </button>
                </nav>
            </div>
        </div>
    </main>

    <!-- Keyboard shortcuts help (optional) -->
    <div
        x-show="showShortcuts"
        x-transition
        class="shortcuts-overlay"
        @click="showShortcuts = false"
    >
        <div
            class="shortcuts-modal"
            @click.stop
        >
            <h3>Keyboard Shortcuts</h3>
            <ul>
                <li><kbd>‚Üê</kbd> Previous chapter</li>
                <li><kbd>‚Üí</kbd> Next chapter</li>
                <li><kbd>Esc</kbd> Close sidebar</li>
            </ul>
            <button @click="showShortcuts = false">Close</button>
        </div>
    </div>
</div>

<script>
    function bibleReader() {
        return {
            // Core data
            book: {},
            currentChapter: 1,
            currentVerses: [],

            // UI state
            sidebarOpen: false,
            loading: true,
            error: null,
            selectedVerse: null,
            showShortcuts: false,

            // Settings
            fontSize: parseInt(localStorage.getItem('fontSize')) || 20,
            theme: localStorage.getItem('theme') || 'dark',
            fontFamily: localStorage.getItem('fontFamily') || 'system-ui, sans-serif',

            // Navigation
            visitedChapters: JSON.parse(localStorage.getItem('visitedChapters')) || [],
            chapterSearch: '',

            // API
            chapterApiTemplate: '',

            get documentTitle() {
                return `${this.book.name} - Chapter ${this.currentChapter}`;
            },

            get isValidChapter() {
                const num = parseInt(this.chapterSearch);
                return num >= 1 && num <= this.book.total_chapters;
            },

            get estimatedReadTime() {
                const wordsPerMinute = 200;
                const wordCount = this.currentVerses.reduce((count, verse) =>
                    count + verse.text.split(' ').length, 0);
                const minutes = Math.ceil(wordCount / wordsPerMinute);
                return `~${minutes} min read`;
            },

            init() {
                const root = this.$root;
                this.book = JSON.parse(root.dataset.book);
                const initialChapter = JSON.parse(root.dataset.initialChapter);
                this.chapterApiTemplate = root.dataset.chapterApiTemplate;

                if (initialChapter) {
                    this.currentChapter = initialChapter.chapter_number;
                    this.currentVerses = initialChapter.verses;
                    this.loading = false;
                    this.markChapterVisited(this.currentChapter);
                }

                document.documentElement.setAttribute('data-theme', this.theme);

                // Close sidebar on mobile when chapter loads
                if (window.innerWidth <= 768) {
                    this.sidebarOpen = false;
                }

                // Preload next chapter
                this.preloadNextChapter();
            },

            async selectChapter(chapterNumber) {
                if (chapterNumber === this.currentChapter) return;

                this.currentChapter = chapterNumber;
                this.selectedVerse = null;
                await this.loadChapter(chapterNumber);

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    this.sidebarOpen = false;
                }

                // Scroll to top
                this.$refs.contentWrapper.scrollTop = 0;
            },

            async loadChapter(chapterNumber) {
                this.loading = true;
                this.error = null;

                try {
                    const url = this.chapterApiTemplate.replace('CHAPTER_NUMBER', chapterNumber);
                    const res = await fetch(url);

                    if (!res.ok) throw new Error(`Chapter ${chapterNumber} not found`);

                    const data = await res.json();
                    this.currentVerses = data.verses;
                    this.markChapterVisited(chapterNumber);

                    // Update URL without page reload
                    const newUrl = `/book/${this.book.slug}/chapter/${chapterNumber}`;
                    history.pushState({ chapter: chapterNumber }, this.documentTitle, newUrl);

                    // Preload next chapter
                    this.preloadNextChapter();

                } catch (err) {
                    console.error(err);
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            },

            async preloadNextChapter() {
                const nextChapter = this.currentChapter + 1;
                if (nextChapter <= this.book.total_chapters) {
                    try {
                        const url = this.chapterApiTemplate.replace('CHAPTER_NUMBER', nextChapter);
                        fetch(url); // Fire and forget preload
                    } catch (e) {
                        // Ignore preload errors
                    }
                }
            },

            markChapterVisited(chapterNumber) {
                if (!this.visitedChapters.includes(chapterNumber)) {
                    this.visitedChapters.push(chapterNumber);
                    localStorage.setItem('visitedChapters', JSON.stringify(this.visitedChapters));
                }
            },

            goToChapter() {
                const chapter = parseInt(this.chapterSearch);
                if (this.isValidChapter) {
                    this.selectChapter(chapter);
                    this.chapterSearch = '';
                }
            },

            validateChapterInput() {
                const num = parseInt(this.chapterSearch);
                if (num > this.book.total_chapters) {
                    this.chapterSearch = this.book.total_chapters.toString();
                }
            },

            selectVerse(verseNumber) {
                this.selectedVerse = this.selectedVerse === verseNumber ? null : verseNumber;
            },

            previousChapter() {
                if (this.currentChapter > 1) {
                    this.selectChapter(this.currentChapter - 1);
                }
            },

            nextChapter() {
                if (this.currentChapter < this.book.total_chapters) {
                    this.selectChapter(this.currentChapter + 1);
                }
            },

            increaseFontSize() {
                if (this.fontSize < 32) {
                    this.fontSize += 2;
                    localStorage.setItem('fontSize', this.fontSize);
                }
            },

            decreaseFontSize() {
                if (this.fontSize > 14) {
                    this.fontSize -= 2;
                    localStorage.setItem('fontSize', this.fontSize);
                }
            },

            toggleTheme() {
                this.theme = this.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', this.theme);
                localStorage.setItem('theme', this.theme);
            },

            retryLoad() {
                this.loadChapter(this.currentChapter);
            }
        };
    }
</script>
{% endblock %}